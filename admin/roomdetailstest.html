<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Y-Spot Admin - Room Details</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon.png">
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link href="css/sb-admin-2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
</head>

<body id="page-top">
    <div id="wrapper">
        <!-- Sidebar -->
        <!-- [Copy your sidebar code here] -->
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <!-- Topbar -->
                <!-- [Copy your topbar code here] -->
                <!-- End of Topbar -->

                <!-- Begin Page Content -->
                <form id="room-details-form">
                    <div class="container-fluid">
                        <div class="border shadow-sm rounded-3 p-3">
                            <div class="rounded bg-white mb-2">
                                <div class="text-center mt-2">
                                    <input type="file" id="roomImages" accept="image/*" multiple>
                                </div>
                                <div class="container row mt-3 d-flex align-items-center justify-content-evenly" id="roomImagesPreview"></div>
                                <div class="row justify-content-center d-flex align-items-center">
                                    <div class="col-md-12">
                                        <div class="p-1 py-1">
                                            <div class="row mt-2 d-flex align-items-center justify-content-center">
                                                <div class="col-lg-5"><label class="labels"><b>Room Type</b></label><input type="text" class="form-control" id="roomType" placeholder="Room Type" required></div>
                                                <div class="col-lg-5"><label class="labels"><b>Bed Type</b></label><input type="text" class="form-control" id="bedType" placeholder="Bed Type" required></div>
                                            </div>
                                            <div class="row mt-2 d-flex align-items-center justify-content-center">
                                                <div class="col-lg-5"><label class="labels"><b>Room ID</b></label><input type="text" class="form-control" id="roomId" placeholder="Room ID" required></div>
                                                <div class="col-lg-5"><label class="labels"><b>Hotel ID</b></label><input type="text" class="form-control" id="hotelId" placeholder="Hotel ID" readonly></div>
                                            </div>
                                            <div class="row mt-2 d-flex align-items-center justify-content-center">
                                                <div class="col-lg-5"><label class="labels"><b>Total Rooms</b></label><input type="text" class="form-control" id="totalRooms" placeholder="Total Rooms" required></div>
                                                <div class="col-lg-5"><label class="labels"><b>Room Price</b></label><input type="text" class="form-control" id="roomPrice" placeholder="Room Price" required></div>
                                            </div>
                                            <div class="row mt-2 d-flex align-items-center justify-content-center">
                                                <div class="col-lg-5"><label class="labels"><b>Per Adult Price</b></label><input type="text" class="form-control" id="perAdultPrice" placeholder="Per Adult Price" required></div>
                                                <div class="col-lg-5"><label class="labels"><b>Per Child Price</b></label><input type="text" class="form-control" id="perChildPrice" placeholder="Per Child Price" required></div>
                                            </div>
                                            <div class="row mt-2 d-flex align-items-center justify-content-center">
                                                <div class="col-lg-5"><label class="labels"><b>Discount</b></label><input type="text" class="form-control" id="discount" placeholder="Discount" required></div>
                                                <div class="col-lg-5"><label class="labels"><b>Availability</b></label><input type="checkbox" id="availability"></div>
                                            </div>
                                            <div class="row mt-2 d-flex align-items-center justify-content-center">
                                                <div class="col-lg-5">
                                                    <label class="labels"><b>Facilities</b></label>
                                                    <select id="facilities" class="form-control">
                                                        <option value="" disabled selected>Select your options</option>
                                                        <option value="WiFi">WiFi</option>
                                                        <option value="Food">Food</option>
                                                        <option value="Parking">Parking</option>
                                                        <option value="AC">AC</option>
                                                        <option value="Water Heater">Water Heater</option>
                                                        <option value="Restaurant">Restaurant</option>
                                                    </select>
                                                    <div id="selected-facilities-container" class="d-flex flex-wrap mb-3"></div>
                                                </div>
                                                <div class="col-lg-5 mt-4"><label class="labels">&nbsp;</label><button style="background-color: #ff1717; color: #fff;" class="btn profile-button" type="submit">Save</button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <script>
                    // firebase-config.js
                    const firebaseConfig = {
                        apiKey: "AIzaSyCkTgEb7H_wNIgVhWwm-l-IzrHXDSe3ni4",
                        authDomain: "testcrud-103a3.firebaseapp.com",
                        databaseURL: "https://testcrud-103a3-default-rtdb.asia-southeast1.firebasedatabase.app",
                        projectId: "testcrud-103a3",
                        storageBucket: "testcrud-103a3.appspot.com",
                        messagingSenderId: "387302339276",
                        appId: "1:387302339276:web:e6c88525a1d80f9d154869",
                        measurementId: "G-ZR3EB3CD3Z"
                    };

                    // Initialize Firebase
                    firebase.initializeApp(firebaseConfig);
                    const db = firebase.firestore();
                    const storage = firebase.storage();

                    const selectElement = document.getElementById('facilities');
                    const selectedFacilitiesContainer = document.getElementById('selected-facilities-container');
                    const selectedFacilities = new Set();

                    firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                            // Retrieve the hotel ID for the logged-in user
                            db.collection('hotels').doc(user.uid).get().then((doc) => {
                                if (doc.exists) {
                                    document.getElementById('hotelId').value = user.uid;
                                } else {
                                    console.log("No hotel details found for this user.");
                                }
                            }).catch((error) => {
                                console.log("Error getting hotel details: ", error);
                            });
                        } else {
                            window.location.href = './login/login.html';
                        }
                    });

                    selectElement.addEventListener('change', (event) => {
                        const selectedValue = event.target.value;
                        if (selectedValue && !selectedFacilities.has(selectedValue)) {
                            selectedFacilities.add(selectedValue);
                            updateSelectedFacilitiesContainer();
                        }
                    });

                    function updateSelectedFacilitiesContainer() {
                        selectedFacilitiesContainer.innerHTML = '';
                        selectedFacilities.forEach(option => {
                            const selectedOption = document.createElement('div');
                            selectedOption.className = 'selected-option';
                            selectedOption.innerHTML = `
                                <span class="m-1">${option}</span>
                                <button type="button" onclick="removeSelectedFacility('${option}')" class="m-1 text-white border-0 rounded" style="background-color:#FF0000">&times;</button>
                            `;
                            selectedFacilitiesContainer.appendChild(selectedOption);
                        });
                    }

                    window.removeSelectedFacility = function (facility) {
                        selectedFacilities.delete(facility);
                        updateSelectedFacilitiesContainer();
                    };

                    const form = document.getElementById('room-details-form');
                    form.addEventListener('submit', async (event) => {
                        event.preventDefault();

                        const roomType = document.getElementById('roomType').value;
                        const bedType = document.getElementById('bedType').value;
                        const roomId = document.getElementById('roomId').value;
                        const hotelId = document.getElementById('hotelId').value;
                        const totalRooms = document.getElementById('totalRooms').value;
                        const roomPrice = document.getElementById('roomPrice').value;
                        const perAdultPrice = document.getElementById('perAdultPrice').value;
                        const perChildPrice = document.getElementById('perChildPrice').value;
                        const discount = document.getElementById('discount').value;
                        const availability = document.getElementById('availability').checked;

                        const roomImages = document.getElementById('roomImages').files;
                        const imageUrls = [];

                        try {
                            for (const file of roomImages) {
                                const storageRef = storage.ref(`rooms/${hotelId}/${roomId}/${file.name}`);
                                const snapshot = await storageRef.put(file);
                                const downloadURL = await snapshot.ref.getDownloadURL();
                                imageUrls.push(downloadURL);
                            }

                            const roomRef = db.collection('hotels').doc(hotelId).collection('rooms').doc(roomId);

                            const roomData = {
                                roomType,
                                bedType,
                                roomId,
                                totalRooms,
                                roomPrice,
                                perAdultPrice,
                                perChildPrice,
                                discount,
                                availability,
                                facilities: Array.from(selectedFacilities),
                                images: imageUrls
                            };

                            const roomDoc = await roomRef.get();
                            if (roomDoc.exists) {
                                await roomRef.update(roomData);
                                alert('Room details updated successfully!');
                            } else {
                                await roomRef.set(roomData);
                                alert('Room details saved successfully!');
                            }

                            form.reset();
                            selectedFacilities.clear();
                            updateSelectedFacilitiesContainer();
                        } catch (error) {
                            console.error('Error adding room details: ', error);
                        }
                    });

                    const imageInput = document.getElementById('roomImages');
                    const imagePreviewContainer = document.getElementById('roomImagesPreview');
                    imageInput.addEventListener('change', () => {
                        imagePreviewContainer.innerHTML = '';
                        const files = imageInput.files;
                        for (const file of files) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                const img = document.createElement('img');
                                img.src = event.target.result;
                                img.style.width = '100px';
                                img.style.height = '100px';
                                img.style.objectFit = 'cover';
                                img.style.margin = '10px';
                                imagePreviewContainer.appendChild(img);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                </script>
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
        <!-- [Copy your footer code here] -->
        <!-- End of Footer -->
    </div>
    <!-- End of Content Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>
</body>

</html>
